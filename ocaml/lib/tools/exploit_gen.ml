(** exploit_gen: Search for known exploits using searchsploit. *)

open Yojson.Safe.Util

let schema : Yojson.Safe.t =
  `Assoc [
    ("type", `String "object");
    ("properties", `Assoc [
      ("query", `Assoc [
        ("type", `String "string");
        ("description", `String "Search query (product name, CVE, or technology)");
      ]);
    ]);
    ("required", `List [`String "query"]);
  ]

let execute (args : Yojson.Safe.t) : (string, string) result =
  let query = args |> member "query" |> to_string_option |> Option.value ~default:"" in
  if query = "" then Error "query is required"
  else
    let argv = ["searchsploit"; "--json"; query] in
    match Subprocess.run_safe ~timeout_secs:30 argv with
    | Ok res ->
      (try
        let _ = Yojson.Safe.from_string res.stdout in
        Ok res.stdout
      with _ ->
        let json = `Assoc [
          ("query", `String query);
          ("raw_output", `String (String.trim res.stdout));
        ] in
        Ok (Yojson.Safe.to_string json))
    | Error e -> Error e

let def : Tool_registry.tool_def = {
  name = "exploit_gen";
  description = "Search for known exploits and proof-of-concept code";
  category = "Intelligence";
  risk_level = Policy.Medium;
  max_exec_secs = 30;
  input_schema = schema;
  execute;
}
