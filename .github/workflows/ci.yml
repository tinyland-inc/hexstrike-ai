name: CI

on:
  push:
    branches: [main, dev, "feat/**"]
  pull_request:
    branches: [main, dev]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Stage 1: Validate ──────────────────────────────
  dhall-check:
    name: Dhall type-check + validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix develop --command just dhall-check
      - run: nix develop --command just dhall-validate

  fstar-verify:
    name: F* verification
    runs-on: ubuntu-latest
    continue-on-error: true  # F*/Z3 may need source build; non-blocking
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix develop .#fstar --command just fstar-verify

  futhark-check:
    name: Futhark type-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix develop --command just futhark-check

  go-vet:
    name: Go vet
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix develop --command bash -c 'cd gateway && go vet ./...'

  # ── Stage 2: Build ─────────────────────────────────
  fstar-extract:
    name: F* → OCaml extraction
    needs: [fstar-verify]
    if: ${{ !cancelled() }}  # Run even if fstar-verify was skipped/failed
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix develop .#fstar --command just fstar-extract

  futhark-build:
    name: Futhark compile
    needs: [futhark-check]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix develop --command just futhark-build

  ocaml-build:
    name: OCaml build
    needs: [dhall-check]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix develop --command just ocaml-build

  gateway-build:
    name: Gateway build
    needs: [go-vet]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix develop --command just gateway-build

  policy-compile:
    name: Policy compile
    needs: [dhall-check]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix develop --command just dhall-render
      - uses: actions/upload-artifact@v4
        with:
          name: tool-manifest
          path: dhall/out/tool-manifest.json

  # ── Stage 3: Test ──────────────────────────────────
  unit-test:
    name: Unit tests (OCaml)
    needs: [ocaml-build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix develop --command just ocaml-test

  futhark-test:
    name: Futhark kernel tests
    needs: [futhark-build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix develop --command just futhark-test

  integration-test:
    name: MCP integration tests
    needs: [ocaml-build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix develop --command bash -c 'dune build --root ocaml && bash test/integration/test_mcp_roundtrip.sh'

  gateway-test:
    name: Gateway tests
    needs: [gateway-build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix develop --command just gateway-test

  # ── Stage 4: Package ─────────────────────────────────
  nix-packages:
    name: Nix package builds
    needs: [unit-test, gateway-test, integration-test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix build .#hexstrike-mcp
      - run: nix build .#hexstrike-gateway
      - run: nix build .#hexstrike-policies

  container:
    name: OCI container build
    needs: [nix-packages]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix build .#container
      - run: |
          echo "Container image: $(ls -lh result)"
          echo "Image size: $(du -h result | cut -f1)"
